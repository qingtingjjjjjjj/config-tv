name: æ›´æ–°ç›´æ’­æº

on:
  schedule:
    - cron: '0 0 * * *'  # UTC æ—¶é—´æ¯å¤© 00:00
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ä»“åº“
        uses: actions/checkout@v3

      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: å®‰è£…ä¾èµ–
        run: pip install requests

      - name: è¿è¡Œä¸‹è½½è„šæœ¬
        run: |
          python - <<'EOF'
          import os
          import requests
          from datetime import datetime

          folder = "."
          os.makedirs(folder, exist_ok=True)

          urls = {
              "video.json": "https://raw.githubusercontent.com/wwb521/live/refs/heads/main/video.json",
              "tv.txt": "https://raw.githubusercontent.com/wwb521/live/refs/heads/main/tv.txt",
              "zubo_all.txt": "https://raw.githubusercontent.com/q1017673817/iptvz/refs/heads/main/zubo_all.txt"
          }

          headers = {
              "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) "
                            "AppleWebKit/537.36 (KHTML, like Gecko) "
                            "Chrome/120.0.0.0 Safari/537.36"
          }

          for filename, url in urls.items():
              file_path = os.path.join(folder, filename)
              print(f"â¡ï¸ æ­£åœ¨ä¸‹è½½: {url} -> {file_path}")
              try:
                  response = requests.get(url, headers=headers, timeout=20)
                  response.raise_for_status()
                  with open(file_path, "wb") as f:
                      f.write(response.content)
                  print(f"âœ… æˆåŠŸæ›´æ–°: {file_path} ({len(response.content)} bytes)")
              except Exception as e:
                  print(f"âŒ ä¸‹è½½å¤±è´¥ {url} -> {e}")

          last_update_file = os.path.join(folder, "last_update.txt")
          with open(last_update_file, "w") as f:
              f.write(f"Last update: {datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S UTC')}\n")
          print(f"ğŸ“… æ›´æ–°æ—¶é—´å·²è®°å½• -> {last_update_file}")
          EOF

      - name: æäº¤æ›´æ–°
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add video.json tv.txt zubo_all.txt last_update.txt
          git commit -m "è‡ªåŠ¨æ›´æ–°ç›´æ’­æº $(date -u +"%Y-%m-%d %H:%M:%S UTC")" || echo "æ²¡æœ‰å˜åŒ–"
          git push
